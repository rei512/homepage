{{- $title := site.Title -}}
{{- $description := site.Params.description | default "Personal blog" -}}
{{- $ogImage := "/images/top_page.png" | absURL -}}
{{- $overlay := resources.Get "images/ogp-overlay.png" -}}

{{- if not .IsHome -}}
  {{- $title = printf "%s - %s" .Title site.Title -}}
  {{- with .Description -}}
    {{- $description = . -}}
  {{- else -}}
    {{- with .Summary -}}
      {{- $description = . | plainify | truncate 150 -}}
    {{- end -}}
  {{- end -}}

  {{/* 記事のOGP画像: 1. ogpImage指定 2. 本文中の最初の画像 3. デフォルト */}}
  {{- $baseImage := false -}}
  {{- with .Params.ogpImage -}}
    {{- $imgPath := . -}}
    {{/* Page Resourceとして解決を試みる */}}
    {{- $resource := $.Resources.GetMatch (strings.TrimPrefix "/" $imgPath) -}}
    {{- with $resource -}}
      {{- $baseImage = . -}}
    {{- else -}}
      {{/* static配下の絶対パスとして扱う */}}
      {{- $ogImage = $imgPath | absURL -}}
    {{- end -}}
  {{- else -}}
    {{- $content := .RawContent -}}
    {{- $imgRegex := `!\[.*?\]\(\.?/?([^)\s"]+)` -}}
    {{- $match := findRE $imgRegex $content 1 -}}
    {{- with index $match 0 -}}
      {{- $imgPath := replaceRE $imgRegex "$1" . -}}
      {{/* Page Resourceとして解決を試みる */}}
      {{- $resource := $.Resources.GetMatch $imgPath -}}
      {{- with $resource -}}
        {{- $baseImage = . -}}
      {{- else -}}
        {{/* static配下の絶対パスとして扱う */}}
        {{- if hasPrefix $imgPath "/" -}}
          {{- $ogImage = $imgPath | absURL -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  {{/* Page Resourceが見つかった場合、オーバーレイを適用 */}}
  {{- with $baseImage -}}
    {{- $resized := .Fill "1200x630 Center" -}}
    {{- if $overlay -}}
      {{- $processed := $resized.Filter (images.Overlay $overlay 0 0) -}}
      {{- $ogImage = $processed.Permalink -}}
    {{- else -}}
      {{- $ogImage = $resized.Permalink -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

<!-- Open Graph -->
<meta property="og:title" content="{{ $title }}">
<meta property="og:description" content="{{ $description }}">
<meta property="og:type" content="{{ if .IsPage }}article{{ else }}website{{ end }}">
<meta property="og:url" content="{{ .Permalink }}">
<meta property="og:image" content="{{ $ogImage }}">
<meta property="og:site_name" content="{{ site.Title }}">
<meta property="og:locale" content="ja_JP">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ $title }}">
<meta name="twitter:description" content="{{ $description }}">
<meta name="twitter:image" content="{{ $ogImage }}">
{{- with site.Params.social.twitter -}}
  {{- $handle := replaceRE `https?://(www\.)?twitter\.com/` "" . -}}
  <meta name="twitter:site" content="@{{ $handle }}">
{{- end -}}
